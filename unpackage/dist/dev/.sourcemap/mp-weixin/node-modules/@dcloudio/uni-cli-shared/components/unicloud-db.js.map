{"version":3,"sources":["webpack:///./node_modules/@dcloudio/uni-cli-shared/components/unicloud-db.vue?a036","webpack:///./node_modules/@dcloudio/uni-cli-shared/components/unicloud-db.vue?4f18","webpack:///./node_modules/@dcloudio/uni-cli-shared/components/unicloud-db.vue?7ac1","webpack:///./node_modules/@dcloudio/uni-cli-shared/components/unicloud-db.vue?17d5","webpack:///node_modules/@dcloudio/uni-cli-shared/components/unicloud-db.vue?5078"],"names":[],"mappings":";;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAwH;AACxH;AAC+D;AACL;;;AAG1D;AACyG;AACzG,gBAAgB,0HAAU;AAC1B,EAAE,iFAAM;AACR,EAAE,sFAAM;AACR,EAAE,+FAAe;AACjB;AACA;AACA;AACA;AACA;AACA,EAAE,0FAAU;AACZ;AACA;;AAEA;AACe,gF;;;;;;;;;;;;ACtBf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAAmV,CAAgB,+XAAG,EAAC,C;;;;;;;;;;;;;;;;;;;;;;;;;;ACcvW;AACA,cADA;AAEA,gBAFA;;AAIA;AACA,YADA;AAEA,oBAFA;;;AAKA;AACA,aADA;AAEA,UAFA;AAGA,YAHA;AAIA,QAJA;AAKA,OALA;AAMA,UANA;AAOA,SAPA;AAQA,OARA,E;;;AAWA;AACA,oBADA;AAEA;AACA;AACA,2BADA;AAEA,aAFA,sBAEA;AACA;AACA,OAJA,EADA;;AAOA;AACA,kBADA;AAEA,iBAFA,EAPA;;AAWA;AACA,kBADA;AAEA,iBAFA,EAXA;;AAeA;AACA,kBADA;AAEA,iBAFA,EAfA;;AAmBA;AACA,kBADA;AAEA,iBAFA,EAnBA;;AAuBA;AACA,4BADA;AAEA,iBAFA,EAvBA;;AA2BA;AACA,kBADA;AAEA,oBAFA,EA3BA;;AA+BA;AACA,kBADA;AAEA,gBAFA,EA/BA;;AAmCA;AACA,kBADA;AAEA,iBAFA,EAnCA;;AAuCA;AACA,6BADA;AAEA,oBAFA,EAvCA;;AA2CA;AACA,6BADA;AAEA,oBAFA,EA3CA;;AA+CA;AACA,6BADA;AAEA,oBAFA,EA/CA;;AAmDA;AACA,kBADA;AAEA,iBAFA,EAnDA;;AAuDA;AACA,kBADA;AAEA,iBAFA,EAvDA;;AA2DA;AACA,mBADA;AAEA,oBAFA,EA3DA,EAFA;;;AAkEA,MAlEA,kBAkEA;AACA;AACA,oBADA;AAEA,oBAFA;AAGA,4CAHA;AAIA;AACA,iCADA;AAEA,2BAFA;AAGA,gBAHA,EAJA;;AASA,sBATA;;AAWA,GA9EA;AA+EA,SA/EA,qBA+EA;AACA;;AAEA;AACA;AACA;AACA;AACA,OAFA;AAGA;AACA,KANA,EAMA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,KAzBA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAmEA;AACA;AACA;AACA,GAxJA;;;;;;;;;;;;;;;AAuKA;AACA,YADA,oBACA,KADA,EACA,KADA,EACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAXA,MAWA;AACA;AACA;;AAEA;AACA,KAnBA;AAoBA,YApBA,sBAoBA;AACA;AACA;AACA;AACA;AACA,KAzBA;AA0BA,WA1BA,qBA0BA;AACA;AACA;AACA,KA7BA;AA8BA,SA9BA,mBA8BA;AACA;AACA;AACA,KAjCA;AAkCA,SAlCA,mBAkCA;AACA;AACA,KApCA;AAqCA,OArCA,eAqCA,KArCA;;;;;AA0CA,uFAJA,UAIA,QAJA,UAIA,CAHA,OAGA,QAHA,OAGA,CAFA,IAEA,QAFA,IAEA,CADA,QACA,QADA,QACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qCADA;;AAGA,OALA,EAKA,KALA,CAKA;AACA;AACA;AACA,8BADA;AAEA,2BAFA;;AAIA,OAXA,EAWA,OAXA,CAWA;AACA;AACA;AACA,OAdA;AAeA,KA7DA;AA8DA,UA9DA,kBA8DA,EA9DA;;;;;;;AAqEA,0GANA,MAMA,SANA,MAMA,CALA,QAKA,SALA,OAKA,CAJA,IAIA,SAJA,IAIA,CAHA,QAGA,SAHA,QAGA,CAFA,YAEA,SAFA,YAEA,CADA,cACA,SADA,cACA;AACA;AACA;AACA;AACA;AACA,mCADA;AAEA,4CAFA;AAGA,wBAHA;AAIA;AACA;AACA;AACA;AACA;AACA,SATA;;AAWA,KApFA;AAqFA,UArFA,kBAqFA,EArFA,EAqFA,KArFA;;;;;AA0FA,wFAJA,UAIA,SAJA,UAIA,CAHA,OAGA,SAHA,OAGA,CAFA,IAEA,SAFA,IAEA,CADA,QACA,SADA,QACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qCADA;;AAGA,OALA,EAKA,KALA,CAKA;AACA;AACA;AACA,8BADA;AAEA,2BAFA;;AAIA,OAXA,EAWA,OAXA,CAWA;AACA;AACA;AACA,OAdA;AAeA,KA7GA;AA8GA,iBA9GA,yBA8GA,QA9GA,EA8GA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,+BADA;;;;AAKA,kBALA,CAGA,IAHA,eAGA,IAHA,CAIA,KAJA,eAIA,KAJA;AAMA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA,SAFA,MAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;;;;;;;;;;;;AAaA,OAtCA,EAsCA,KAtCA,CAsCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OA9CA;AA+CA,KApKA;AAqKA,YArKA,sBAqKA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAlBA;;;;;AAuBA,6BAvBA,CAqBA,OArBA,yBAqBA,OArBA,CAsBA,IAtBA,yBAsBA,IAtBA;AAwBA;AACA;AACA;AACA;AACA;AACA;AACA,qCADA;AAEA,mCAFA;;AAIA;AACA;;AAEA;AACA,KA1MA;AA2MA,eA3MA,uBA2MA,EA3MA,EA2MA,MA3MA,EA2MA,OA3MA,EA2MA,IA3MA,EA2MA,QA3MA,EA2MA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,kBADA;;;AAIA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA,0BADA;AAEA,YAFA,GAEA,IAFA,CAEA;AACA;AACA;AACA;AACA,SAFA,MAEA;AACA;AACA;AACA,OATA,EASA,KATA,CASA;AACA;AACA;AACA,8BADA;AAEA,2BAFA;;AAIA,OAfA,EAeA,OAfA,CAeA;AACA;AACA;AACA,OAlBA;AAmBA,KArPA;AAsPA,cAtPA,sBAsPA,GAtPA,EAsPA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAhQA;AAiQA,kBAjQA,0BAiQA,IAjQA,EAiQA,IAjQA,EAiQA;AACA;AACA;AACA,OAFA,MAEA;AACA;AACA;AACA,KAvQA,EAvKA,E","file":"node-modules/@dcloudio/uni-cli-shared/components/unicloud-db.js","sourcesContent":["import { render, staticRenderFns, recyclableRender, components } from \"./unicloud-db.vue?vue&type=template&id=8ef09edc&\"\nvar renderjs\nimport script from \"./unicloud-db.vue?vue&type=script&lang=js&\"\nexport * from \"./unicloud-db.vue?vue&type=script&lang=js&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../vue-cli-plugin-uni/packages/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"Applications/HBuilderX.app/Contents/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/uni-cli-shared/components/unicloud-db.vue\"\nexport default component.exports","export * from \"-!../../vue-cli-plugin-uni/packages/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--16-0!../../webpack-uni-mp-loader/lib/template.js!../../vue-cli-plugin-uni/packages/webpack-uni-app-loader/page-meta.js!../../vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../webpack-uni-mp-loader/lib/style.js!./unicloud-db.vue?vue&type=template&id=8ef09edc&\"","var components\nvar render = function() {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!../../../babel-loader/lib/index.js!../../vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--12-1!../../webpack-uni-mp-loader/lib/script.js!../../vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../webpack-uni-mp-loader/lib/style.js!./unicloud-db.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../babel-loader/lib/index.js!../../vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--12-1!../../webpack-uni-mp-loader/lib/script.js!../../vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../webpack-uni-mp-loader/lib/style.js!./unicloud-db.vue?vue&type=script&lang=js&\"","<template>\n  <view>\n    <slot\n      :options=\"options\"\n      :data=\"dataList\"\n      :pagination=\"paginationInternal\"\n      :loading=\"loading\"\n      :hasMore=\"hasMore\"\n      :error=\"errorMessage\"\n    />\n  </view>\n</template>\n\n<script>\nconst events = {\n  load: 'load',\n  error: 'error'\n}\nconst pageMode = {\n  add: 'add',\n  replace: 'replace'\n}\n\nconst attrs = [\n  'pageCurrent',\n  'pageSize',\n  'collection',\n  'action',\n  'field',\n  'getcount',\n  'orderby',\n  'where'\n]\n\nexport default {\n  name: 'UniClouddb',\n  props: {\n    options: {\n      type: [Object, Array],\n      default () {\n        return {}\n      }\n    },\n    collection: {\n      type: String,\n      default: ''\n    },\n    action: {\n      type: String,\n      default: ''\n    },\n    field: {\n      type: String,\n      default: ''\n    },\n    orderby: {\n      type: String,\n      default: ''\n    },\n    where: {\n      type: [String, Object],\n      default: ''\n    },\n    pageData: {\n      type: String,\n      default: 'add'\n    },\n    pageCurrent: {\n      type: Number,\n      default: 1\n    },\n    pageSize: {\n      type: Number,\n      default: 20\n    },\n    getcount: {\n      type: [Boolean, String],\n      default: false\n    },\n    getone: {\n      type: [Boolean, String],\n      default: false\n    },\n    gettree: {\n      type: [Boolean, String],\n      default: false\n    },\n    startwith: {\n      type: String,\n      default: ''\n    },\n    limitlevel: {\n      type: Number,\n      default: 10\n    },\n    manual: {\n      type: Boolean,\n      default: false\n    }\n  },\n  data () {\n    return {\n      loading: false,\n      hasMore: false,\n      dataList: this.getone ? undefined : [],\n      paginationInternal: {\n        current: this.pageCurrent,\n        size: this.pageSize,\n        count: 0\n      },\n      errorMessage: ''\n    }\n  },\n  created () {\n    this._isEnded = false\n\n    this.$watch(() => {\n      var al = []\n      attrs.forEach(key => {\n        al.push(this[key])\n      })\n      return al\n    }, (newValue, oldValue) => {\n      this.paginationInternal.size = this.pageSize\n\n      let needReset = false\n      for (let i = 2; i < newValue.length; i++) {\n        if (newValue[i] !== oldValue[i]) {\n          needReset = true\n          break\n        }\n      }\n      if (needReset) {\n        this.clear()\n        this.reset()\n      }\n      if (newValue[0] !== oldValue[0]) {\n        this.paginationInternal.current = this.pageCurrent\n      }\n\n      this._execLoadData()\n    })\n\n    // #ifdef H5\n    if (process.env.NODE_ENV === 'development') {\n      this._debugDataList = []\n      if (!window.unidev) {\n        window.unidev = {\n          clientDB: {\n            data: []\n          }\n        }\n      }\n      window.unidev.clientDB.data.push(this._debugDataList)\n    }\n    // #endif\n\n    // #ifdef MP-TOUTIAO\n    let changeName\n    const events = this.$scope.dataset.eventOpts\n    for (var i = 0; i < events.length; i++) {\n      const event = events[i]\n      if (event[0].includes('^load')) {\n        changeName = event[1][0][0]\n      }\n    }\n    if (changeName) {\n      let parent = this.$parent\n      let maxDepth = 16\n      this._changeDataFunction = null\n      while (parent && maxDepth > 0) {\n        const fun = parent[changeName]\n        if (fun && typeof fun === 'function') {\n          this._changeDataFunction = fun\n          maxDepth = 0\n          break\n        }\n        parent = parent.$parent\n        maxDepth--\n      }\n    }\n    // #endif\n\n    if (!this.manual) {\n      this.loadData()\n    }\n  },\n  // #ifdef H5\n  beforeDestroy () {\n    if (process.env.NODE_ENV === 'development' && window.unidev) {\n      var cd = this._debugDataList\n      var dl = window.unidev.clientDB.data\n      for (var i = dl.length - 1; i >= 0; i--) {\n        if (dl[i] === cd) {\n          dl.splice(i, 1)\n          break\n        }\n      }\n    }\n  },\n  // #endif\n  methods: {\n    loadData (args1, args2) {\n      let callback = null\n      if (typeof args1 === 'object') {\n        if (args1.clear) {\n          this.clear()\n          this.reset()\n        }\n        if (args1.current !== undefined) {\n          this.paginationInternal.current = args1.current\n        }\n        if (typeof args2 === 'function') {\n          callback = args2\n        }\n      } else if (typeof args1 === 'function') {\n        callback = args1\n      }\n\n      this._execLoadData(callback)\n    },\n    loadMore () {\n      if (this._isEnded) {\n        return\n      }\n      this._execLoadData()\n    },\n    refresh () {\n      this.clear()\n      this._execLoadData()\n    },\n    clear () {\n      this._isEnded = false\n      this.dataList = []\n    },\n    reset () {\n      this.paginationInternal.current = 1\n    },\n    add (value, {\n      toastTitle,\n      success,\n      fail,\n      complete\n    } = {}) {\n      uni.showLoading()\n      /* eslint-disable no-undef */\n      const db = uniCloud.database()\n      db.collection(this.collection).add(value).then((res) => {\n        success && success(res)\n        uni.showToast({\n          title: toastTitle || '新增成功'\n        })\n      }).catch((err) => {\n        fail && fail(err)\n        uni.showModal({\n          content: err.message,\n          showCancel: false\n        })\n      }).finally(() => {\n        uni.hideLoading()\n        complete && complete()\n      })\n    },\n    remove (id, {\n      action,\n      success,\n      fail,\n      complete,\n      confirmTitle,\n      confirmContent\n    } = {}) {\n      if (!id || !id.length) {\n        return\n      }\n      uni.showModal({\n        title: confirmTitle || '提示',\n        content: confirmContent || '是否删除该数据',\n        showCancel: true,\n        success: (res) => {\n          if (!res.confirm) {\n            return\n          }\n          this._execRemove(id, action, success, fail, complete)\n        }\n      })\n    },\n    update (id, value, {\n      toastTitle,\n      success,\n      fail,\n      complete\n    } = {}) {\n      uni.showLoading()\n      /* eslint-disable no-undef */\n      const db = uniCloud.database()\n      return db.collection(this.collection).doc(id).update(value).then((res) => {\n        success && success(res)\n        uni.showToast({\n          title: toastTitle || '修改成功'\n        })\n      }).catch((err) => {\n        fail && fail(err)\n        uni.showModal({\n          content: err.message,\n          showCancel: false\n        })\n      }).finally(() => {\n        uni.hideLoading()\n        complete && complete()\n      })\n    },\n    _execLoadData (callback) {\n      if (this.loading) {\n        return\n      }\n      this.loading = true\n      this.errorMessage = ''\n\n      this._getExec().then((res) => {\n        this.loading = false\n        const {\n          data,\n          count\n        } = res.result\n        this._isEnded = data.length < this.pageSize\n        this.hasMore = !this._isEnded\n\n        const data2 = this.getone ? (data.length ? data[0] : undefined) : data\n\n        callback && callback(data2, this._isEnded)\n        this._dispatchEvent(events.load, data2)\n\n        if (this.getone || this.pageData === pageMode.replace) {\n          this.dataList = data2\n        } else {\n          this.dataList.push(...data2)\n          if (this.dataList.length) {\n            this.paginationInternal.current++\n          }\n        }\n\n        if (this.getcount) {\n          this.paginationInternal.count = count\n        }\n\n        // #ifdef H5\n        if (process.env.NODE_ENV === 'development') {\n          this._debugDataList.length = 0\n          const formatData = JSON.parse(JSON.stringify(this.dataList))\n          if (Array.isArray(this.dataList)) {\n            this._debugDataList.push(...formatData)\n          } else {\n            this._debugDataList.push(formatData)\n          }\n        }\n        // #endif\n      }).catch((err) => {\n        this.loading = false\n        this.errorMessage = err\n        callback && callback()\n        this.$emit(events.error, err)\n        if (process.env.NODE_ENV === 'development') {\n          console.error(err)\n        }\n      })\n    },\n    _getExec () {\n      /* eslint-disable no-undef */\n      let db = uniCloud.database()\n\n      if (this.action) {\n        db = db.action(this.action)\n      }\n\n      db = db.collection(this.collection)\n\n      if (!(!this.where || !Object.keys(this.where).length)) {\n        db = db.where(this.where)\n      }\n      if (this.field) {\n        db = db.field(this.field)\n      }\n      if (this.orderby) {\n        db = db.orderBy(this.orderby)\n      }\n\n      const {\n        current,\n        size\n      } = this.paginationInternal\n      const getOptions = {}\n      if (this.getcount) {\n        getOptions.getCount = this.getcount\n      }\n      if (this.gettree) {\n        getOptions.getTree = {\n          limitLevel: this.limitlevel,\n          startWith: this.startwith\n        }\n      }\n      db = db.skip(size * (current - 1)).limit(size).get(getOptions)\n\n      return db\n    },\n    _execRemove (id, action, success, fail, complete) {\n      if (!this.collection || !id) {\n        return\n      }\n\n      const ids = Array.isArray(id) ? id : [id]\n      if (!ids.length) {\n        return\n      }\n\n      uni.showLoading({\n        mask: true\n      })\n\n      /* eslint-disable no-undef */\n      const db = uniCloud.database()\n      const dbCmd = db.command\n\n      let exec = db\n      if (action) {\n        exec = exec.action(action)\n      }\n\n      exec.collection(this.collection).where({\n        _id: dbCmd.in(ids)\n      }).remove().then((res) => {\n        success && success(res.result)\n        if (this.pageData === pageMode.replace) {\n          this.refresh()\n        } else {\n          this.removeData(ids)\n        }\n      }).catch((err) => {\n        fail && fail(err)\n        uni.showModal({\n          content: err.message,\n          showCancel: false\n        })\n      }).finally(() => {\n        uni.hideLoading()\n        complete && complete()\n      })\n    },\n    removeData (ids) {\n      const il = ids.slice(0)\n      const dl = this.dataList\n      for (let i = dl.length - 1; i >= 0; i--) {\n        const index = il.indexOf(dl[i]._id)\n        if (index >= 0) {\n          dl.splice(i, 1)\n          il.splice(index, 1)\n        }\n      }\n    },\n    _dispatchEvent (type, data) {\n      if (this._changeDataFunction) {\n        this._changeDataFunction(data, this._isEnded)\n      } else {\n        this.$emit(type, data, this._isEnded)\n      }\n    }\n  }\n}\n</script>\n"],"sourceRoot":""}